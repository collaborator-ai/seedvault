<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Seedvault</title>
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous" />
	<link
		href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;1,400&display=swap"
		rel="stylesheet" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.2/src/regular/style.css" />
	<style>
		/* ── Variables ── */

		:root {
			--bg: #F5F3EE;
			--surface: #FFFFFF;
			--surface-hover: #F0EDE6;
			--surface-active: rgba(62, 124, 83, 0.07);
			--border: #E2DED6;
			--border-subtle: #ECEAE4;
			--text: #1D1D1B;
			--text-secondary: #7D7870;
			--text-tertiary: #B0A99E;
			--accent: #3E7C53;
			--accent-hover: #346A47;
			--accent-text: #FFFFFF;
			--highlight: #C4903D;
			--highlight-dim: rgba(196, 144, 61, 0.10);
			--diff-add: #2E7D42;
			--diff-del: #C62828;
			--diff-hunk: #6A42C1;
			--code-bg: rgba(0, 0, 0, 0.035);
			--shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
			--shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
			--radius: 3px;
			--radius-sm: 2px;
			--font-body: system-ui, -apple-system, sans-serif;
			--font-mono: 'IBM Plex Mono', ui-monospace, monospace;
			--transition: 150ms ease;
		}

		@media (prefers-color-scheme: dark) {
			:root {
				--bg: #0A0A09;
				--surface: #111110;
				--surface-hover: #1A1A18;
				--surface-active: rgba(107, 175, 126, 0.08);
				--border: #222220;
				--border-subtle: #1A1A18;
				--text: #D4D0C8;
				--text-secondary: #8E887E;
				--text-tertiary: #5A554D;
				--accent: #6BAF7E;
				--accent-hover: #82C494;
				--accent-text: #0A0A09;
				--highlight: #D4A853;
				--highlight-dim: rgba(212, 168, 83, 0.12);
				--diff-add: #81C784;
				--diff-del: #EF9A9A;
				--diff-hunk: #B39DDB;
				--code-bg: rgba(255, 255, 255, 0.04);
				--shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
				--shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
			}
		}

		/* ── Reset & Base ── */

		*,
		*::before,
		*::after {
			box-sizing: border-box;
			margin: 0;
		}

		html {
			font-family: var(--font-body);
			font-size: 13px;
			background: var(--bg);
			color: var(--text);
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		html,
		body {
			height: 100%;
		}

		body {
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}

		/* ── Top Bar ── */

		.top-bar {
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 12px;
			padding: 0 16px;
			height: 52px;
			flex-shrink: 0;
			border-bottom: 1px solid var(--border);
			background: var(--surface);
		}

		.top-bar-left {
			display: flex;
			align-items: center;
			gap: 12px;
		}

		#contributor-select {
			font-family: var(--font-body);
			font-size: 13px;
			font-weight: 500;
			padding: 6px 28px 6px 10px;
			min-width: 120px;
			cursor: pointer;
			appearance: none;
			-webkit-appearance: none;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237D7870'/%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: right 10px center;
		}

		#contributor-select:focus {
			border-color: var(--accent);
		}

		#contributor-select:disabled {
			opacity: 0.5;
			cursor: default;
		}

		@media (prefers-color-scheme: dark) {
			#contributor-select {
				background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238E887E'/%3E%3C/svg%3E");
			}
		}

		.top-bar-right {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		input,
		select {
			font-family: var(--font-mono);
			font-size: 12px;
			padding: 6px 10px;
			background: var(--bg);
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: var(--radius-sm);
			outline: none;
			transition: border-color var(--transition);
		}

		input:focus {
			border-color: var(--accent);
		}

		input::placeholder {
			color: var(--text-tertiary);
		}

		#token {
			width: 240px;
		}

		button {
			font-family: var(--font-mono);
			font-size: 11px;
			font-weight: 500;
			cursor: pointer;
			border: none;
			background: transparent;
			color: var(--text);
			padding: 0;
			transition: color var(--transition), background var(--transition), opacity var(--transition);
		}

		.btn-primary {
			padding: 6px 14px;
			background: var(--accent);
			color: var(--accent-text);
			border-radius: var(--radius-sm);
		}

		.btn-primary:hover {
			background: var(--accent-hover);
		}

		#menu-toggle {
			display: none;
			padding: 6px 8px;
			font-size: 18px;
			border-radius: var(--radius-sm);
		}

		#menu-toggle:hover {
			background: var(--surface-hover);
		}

		/* ── Mobile Nav ── */

		#nav-close {
			display: none;
			padding: 4px;
			font-size: 16px;
			border-radius: var(--radius-sm);
			opacity: 0.5;
		}

		#nav-close:hover {
			opacity: 1;
			background: var(--surface-hover);
		}

		#backdrop {
			display: none;
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, 0.35);
			z-index: 90;
			backdrop-filter: blur(2px);
			-webkit-backdrop-filter: blur(2px);
		}

		#backdrop.visible {
			display: block;
		}

		/* ── Grid Layout ── */

		.grid {
			display: flex;
			flex: 1;
			min-height: 0;
		}

		.grid>.panel:first-child {
			flex-shrink: 0;
			background: var(--surface);
			border-right: 1px solid var(--border);
		}

		.grid>.panel:last-child {
			flex: 1;
			min-width: 0;
			background: var(--bg);
		}

		.divider {
			width: 4px;
			cursor: col-resize;
			background: transparent;
			flex-shrink: 0;
			position: relative;
			z-index: 2;
			margin-left: -2px;
			margin-right: -2px;
		}

		.divider:hover,
		.divider.dragging {
			background: var(--accent);
			opacity: 0.3;
		}

		/* ── Panels ── */

		.panel {
			display: flex;
			flex-direction: column;
			min-height: 0;
			overflow: hidden;
		}

		.panel-head {
			padding: 10px 14px;
			border-bottom: 1px solid var(--border-subtle);
			font-family: var(--font-mono);
			font-size: 11px;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.06em;
			color: var(--text-secondary);
			flex-shrink: 0;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		#nav-body:focus {
			outline: none;
		}

		.panel-body {
			flex: 1;
			overflow: auto;
			scrollbar-width: thin;
			scrollbar-color: var(--border) transparent;
		}

		.grid>.panel:last-child>.panel-body {
			overflow: auto;
		}

		/* ── Scrollbars ── */

		.panel-body::-webkit-scrollbar,
		#content::-webkit-scrollbar,
		#activity-dialog-body::-webkit-scrollbar {
			width: 6px;
			height: 6px;
		}

		.panel-body::-webkit-scrollbar-track,
		#content::-webkit-scrollbar-track,
		#activity-dialog-body::-webkit-scrollbar-track {
			background: transparent;
		}

		.panel-body::-webkit-scrollbar-thumb,
		#content::-webkit-scrollbar-thumb,
		#activity-dialog-body::-webkit-scrollbar-thumb {
			background: var(--border);
			border-radius: 3px;
		}

		.panel-body::-webkit-scrollbar-thumb:hover,
		#content::-webkit-scrollbar-thumb:hover,
		#activity-dialog-body::-webkit-scrollbar-thumb:hover {
			background: var(--text-tertiary);
		}

		/* ── File Tree ── */

		.tree {
			list-style: none;
			padding: 4px 0;
		}

		.tree ul {
			list-style: none;
			padding: 0;
		}

		.tree-row {
			display: flex;
			align-items: baseline;
			width: 100%;
			text-align: left;
			padding: 5px 12px;
			white-space: nowrap;
			overflow: hidden;
			cursor: pointer;
			border-left: 2px solid transparent;
			border-radius: 0;
			font-family: var(--font-mono);
			font-size: 11px;
			transition: background var(--transition), border-color var(--transition), color var(--transition);
		}

		.tree-row .name {
			overflow: hidden;
			text-overflow: ellipsis;
			flex: 1;
			min-width: 0;
		}

		.tree-row .ctime {
			flex-shrink: 0;
			margin-left: 8px;
			color: var(--text-tertiary);
			font-size: 10px;
			font-family: var(--font-mono);
		}

		.tree-row:hover {
			background: var(--surface-hover);
		}

		.tree-row.active {
			background: var(--text);
			border-left-color: transparent;
			color: var(--bg);
			font-weight: 500;
		}

		.tree-row .arrow {
			display: inline-block;
			width: 1em;
			text-align: center;
			font-size: 9px;
			color: var(--text-tertiary);
			transition: color var(--transition);
		}

		.tree-row:hover .arrow {
			color: var(--text-secondary);
		}

		.tree-row .ph {
			display: inline-block;
			font-size: 14px;
			margin-left: 6px;
			margin-right: 4px;
			vertical-align: -0.12em;
			color: var(--text-tertiary);
		}

		.tree-row.active .ph {
			color: var(--bg);
		}

		.tree-row.active .ctime {
			color: var(--bg);
			opacity: 0.6;
		}

		.tree-row.active .arrow {
			color: var(--bg);
		}

		.tree ul.collapsed {
			display: none;
		}

		/* ── Item Header ── */

		.item-header {
			padding: 24px 0 20px;
			margin-bottom: 20px;
			border-bottom: 1px solid var(--border);
		}

		.item-header-title {
			font-family: var(--font-body);
			font-size: 5rem;
			font-weight: 500;
			line-height: 1.05;
			letter-spacing: -0.01em;
			color: var(--text);
			overflow-wrap: break-word;
			word-break: break-word;
		}

		.item-header-path {
			font-size: 11px;
			font-family: var(--font-mono);
			color: var(--text-tertiary);
			margin-bottom: 6px;
		}

		.item-header-meta {
			display: flex;
			flex-direction: column;
			gap: 6px;
			margin-top: 14px;
			font-size: 12px;
		}

		.item-header-meta .meta-field {
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.item-header-meta .meta-label {
			font-weight: 600;
			text-transform: uppercase;
			font-size: 10px;
			letter-spacing: 0.04em;
			color: var(--text-tertiary);
		}

		.item-header-meta .meta-value {
			font-family: var(--font-mono);
			font-size: 11px;
			color: var(--text-secondary);
		}

		.item-header-meta .meta-tag {
			display: inline-block;
			padding: 2px 8px;
			border-radius: 99px;
			background: var(--surface-hover);
			border: 1px solid var(--border-subtle);
			font-size: 11px;
			color: var(--text-secondary);
		}

		/* ── Empty State ── */

		.empty-state {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
			color: var(--text-tertiary);
			gap: 12px;
			user-select: none;
		}

		.empty-state .ph {
			font-size: 48px;
			opacity: 0.4;
		}

		.empty-state p {
			font-size: 14px;
			font-weight: 500;
		}

		/* ── Content / Markdown ── */

		#content {
			font-family: var(--font-body);
			font-size: 16px;
			padding: 28px 32px;
			line-height: 1.5;
			color: var(--text);
			max-width: 544px;
			margin: 0 auto;
		}

		#content h1 {
			font-size: 2rem;
			font-weight: 600;
			margin: 1rem 0 0.5rem;
			line-height: 2.5rem;
			letter-spacing: 0.02rem;
		}

		#content h2 {
			font-size: 1.6rem;
			font-weight: 600;
			margin: 1rem 0 0.3rem;
			line-height: 2.5rem;
			letter-spacing: 0.02rem;
		}

		#content h3 {
			font-size: 1.2rem;
			font-weight: 600;
			margin: 0.2rem 0 0;
			line-height: 2rem;
			letter-spacing: 0.02rem;
		}

		#content h4,
		#content h5,
		#content h6 {
			font-size: 1em;
			font-weight: 600;
			margin: 0.8em 0 0.4em;
		}

		#content p {
			margin: 0 0 0.8em;
		}

		#content img {
			max-width: 100%;
			height: auto;
			display: block;
			border-radius: var(--radius-sm);
		}

		#content ul,
		#content ol {
			margin: 0 0 0.8em;
			padding-left: 1.4em;
		}

		#content li {
			margin-bottom: 0.2em;
		}

		#content pre,
		#content code {
			font-family: var(--font-mono);
			font-size: 0.88em;
		}

		#content pre {
			background: var(--code-bg);
			padding: 14px 16px;
			border-radius: var(--radius);
			overflow-x: auto;
			margin: 0.6em 0 1em;
			border: 1px solid var(--border-subtle);
			line-height: 1.5;
		}

		#content code {
			padding: 0.15em 0.35em;
			border-radius: var(--radius-sm);
			background: var(--code-bg);
		}

		#content pre code {
			padding: 0;
			background: none;
			border: none;
		}

		#content blockquote {
			border-left: 3px solid var(--accent);
			margin: 0.6em 0 1em;
			padding: 0.3em 0 0.3em 1em;
			color: var(--text-secondary);
		}

		#content blockquote p:last-child {
			margin-bottom: 0;
		}

		#content a {
			color: var(--accent);
			text-decoration: underline;
			text-decoration-color: rgba(62, 124, 83, 0.3);
			text-underline-offset: 2px;
			transition: text-decoration-color var(--transition);
		}

		#content a:hover {
			text-decoration-color: var(--accent);
		}

		@media (prefers-color-scheme: dark) {
			#content a {
				text-decoration-color: rgba(107, 175, 126, 0.3);
			}
		}

		#content hr {
			border: none;
			border-top: 1px solid var(--border);
			margin: 2em 0;
		}

		#content table {
			border-collapse: collapse;
			margin: 0.6em 0 1em;
			font-size: 0.92em;
		}

		#content th,
		#content td {
			border: 1px solid var(--border);
			padding: 8px 12px;
			text-align: left;
		}

		#content th {
			background: var(--code-bg);
			font-weight: 600;
		}

		/* ── Status Bar ── */

		#status {
			padding: 0 16px;
			height: 32px;
			font-size: 11px;
			color: var(--text-tertiary);
			flex-shrink: 0;
			display: flex;
			align-items: center;
			border-top: 1px solid var(--border-subtle);
			background: var(--surface);
		}

		#status-text {
			flex: 1;
			font-family: var(--font-mono);
			font-size: 11px;
		}

		#activity-btn {
			font-size: 11px;
			font-weight: 500;
			padding: 4px 8px;
			border-radius: var(--radius-sm);
			color: var(--text-secondary);
			display: flex;
			align-items: center;
			gap: 4px;
		}

		#activity-btn:hover {
			color: var(--text);
			background: var(--surface-hover);
		}

		/* ── Activity Panel ── */

		#activity-modal {
			display: none;
			position: fixed;
			inset: 0;
			z-index: 300;
		}

		#activity-modal.open {
			display: flex;
		}

		#activity-overlay {
			position: absolute;
			inset: 0;
			background: rgba(0, 0, 0, 0.3);
			backdrop-filter: blur(2px);
			-webkit-backdrop-filter: blur(2px);
			animation: fadeIn 0.2s ease;
		}

		#activity-dialog {
			position: absolute;
			inset: 0;
			background: var(--surface);
			color: var(--text);
			display: flex;
			flex-direction: column;
			overflow: hidden;
			z-index: 1;
			animation: fadeIn 0.2s ease;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
			}

			to {
				opacity: 1;
			}
		}


		#activity-dialog-head {
			padding: 10px 16px;
			border-bottom: 1px solid var(--border);
			font-size: 12px;
			font-weight: 600;
			display: flex;
			align-items: center;
			flex-shrink: 0;
			color: var(--text-secondary);
		}

		#activity-dialog-head span {
			display: flex;
			align-items: center;
			gap: 6px;
		}

		#activity-dialog-head .ph {
			font-size: 16px;
			color: var(--accent);
		}

		#activity-dialog-head button {
			margin-left: auto;
			padding: 4px 6px;
			font-size: 16px;
			border-radius: var(--radius-sm);
			color: var(--text-tertiary);
		}

		#activity-dialog-head button:hover {
			color: var(--text);
			background: var(--surface-hover);
		}

		#activity-dialog-body {
			flex: 1;
			overflow-y: auto;
			scrollbar-width: thin;
			scrollbar-color: var(--border) transparent;
		}

		.activity-list {
			padding: 12px 0;
			margin: 0;
			list-style: none;
		}

		.activity-item {
			display: grid;
			grid-template-columns: 90px 20px 1fr;
			gap: 0 8px;
			min-height: 40px;
		}

		.activity-time-col {
			text-align: right;
			padding-top: 6px;
		}

		.activity-time {
			font-size: 11px;
			font-family: var(--font-mono);
			color: var(--text-secondary);
			white-space: nowrap;
		}

		.activity-date {
			font-size: 10px;
			color: var(--text-tertiary);
		}

		.activity-dot-col {
			position: relative;
			display: flex;
			flex-direction: column;
			align-items: center;
		}

		.activity-dot-col::after {
			content: '';
			position: absolute;
			left: 50%;
			top: 0;
			bottom: 0;
			width: 1px;
			transform: translateX(-50%);
			background: var(--border);
		}

		.activity-item:first-child .activity-dot-col::after {
			top: 13px;
		}

		.activity-item:last-child .activity-dot-col::after {
			bottom: calc(100% - 14px);
		}

		.activity-dot {
			width: 6px;
			height: 6px;
			border-radius: 50%;
			background: var(--accent);
			opacity: 0.5;
			flex-shrink: 0;
			margin-top: 10px;
			position: relative;
			z-index: 1;
		}

		.activity-line {
			display: none;
		}

		.activity-content {
			padding: 6px 16px 8px 0;
			min-width: 0;
		}

		.activity-action {
			font-family: var(--font-mono);
			font-size: 11px;
			font-weight: 500;
		}

		.activity-by {
			font-size: 11px;
			color: var(--text-tertiary);
		}

		.activity-contributor {
			font-weight: 600;
			color: var(--text-secondary);
		}

		.activity-detail {
			margin-top: 3px;
			font-size: 11px;
			color: var(--text-tertiary);
			font-family: var(--font-mono);
			word-break: break-all;
		}

		.activity-diff {
			margin-top: 6px;
			font-family: var(--font-mono);
			font-size: 11px;
			line-height: 1.45;
			white-space: pre-wrap;
			word-break: break-all;
			padding: 8px 10px;
			background: var(--code-bg);
			border-radius: var(--radius-sm);
			border: 1px solid var(--border-subtle);
			overflow-x: auto;
		}

		.activity-diff .diff-add {
			color: var(--diff-add);
		}

		.activity-diff .diff-del {
			color: var(--diff-del);
		}

		.activity-diff .diff-hunk {
			color: var(--diff-hunk);
			opacity: 0.7;
		}

		.activity-diff-truncated {
			font-size: 10px;
			color: var(--text-tertiary);
			font-style: italic;
			margin-top: 2px;
		}

		#activity-load-more {
			width: 100%;
			padding: 10px;
			border-top: 1px solid var(--border-subtle);
			font-size: 11px;
			font-weight: 500;
			text-transform: uppercase;
			letter-spacing: 0.06em;
			color: var(--text-tertiary);
		}

		#activity-load-more:hover {
			color: var(--text);
			background: var(--surface-hover);
		}

		/* ── Responsive ── */

		@media (max-width: 600px) {
			.top-bar {
				padding: 0 12px;
				height: 48px;
				gap: 8px;
			}

			.top-bar-right {
				flex: 1;
				min-width: 0;
			}

			#contributor-select {
				min-width: 100px;
				flex-shrink: 1;
			}

			#token {
				width: auto;
				flex: 1;
				min-width: 80px;
			}

			#menu-toggle {
				display: flex;
				align-items: center;
			}

			#nav-close {
				display: flex;
				align-items: center;
			}

			.grid {
				flex-direction: column;
				position: relative;
			}

			#nav {
				position: fixed;
				top: 0;
				left: -100vw;
				width: 100vw !important;
				height: 100%;
				z-index: 100;
				background: var(--surface);
				transition: transform 0.2s ease;
				border-right: none !important;
			}

			#nav.open {
				transform: translateX(100vw);
			}

			.grid>.panel:first-child {
				width: auto;
			}

			.divider {
				display: none;
			}

			#content {
				padding: 20px 16px;
			}

			.item-header-title {
				font-size: 3rem;
			}
		}
	</style>
</head>

<body>
	<header class="top-bar">
		<div class="top-bar-left">
			<button id="menu-toggle" aria-label="Toggle navigation"><i class="ph ph-list"></i></button>
			<select id="contributor-select" disabled>
				<option value="">Contributors</option>
			</select>
		</div>
		<div class="top-bar-right">
			<input id="token" type="password" placeholder="API key" />
			<button id="connect" class="btn-primary">Connect</button>
		</div>
	</header>
	<div id="backdrop"></div>
	<div class="grid">
		<section id="nav" class="panel" style="width:260px">
			<div class="panel-head"><span>Files</span><button id="nav-close" aria-label="Close navigation"><i
						class="ph ph-x"></i></button></div>
			<div class="panel-body" id="nav-body" tabindex="0">
				<ul id="files" class="tree"></ul>
			</div>
		</section>
		<div id="divider" class="divider"></div>
		<section class="panel">
			<div class="panel-body">
				<div id="content">
					<div id="item-header" class="item-header" hidden>
						<div class="item-header-path" id="item-path"></div>
						<div class="item-header-title" id="item-title"></div>
						<div class="item-header-meta" id="item-meta"></div>
					</div>
					<div id="content-body">
						<div class="empty-state">
							<i class="ph ph-plant"></i>
							<p>Select a file to view</p>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>
	<div id="activity-modal">
		<div id="activity-overlay"></div>
		<div id="activity-dialog">
			<div id="activity-dialog-head"><span><i class="ph ph-pulse"></i> Activity</span><button id="activity-close"
					aria-label="Close"><i class="ph ph-x"></i></button></div>
			<div id="activity-dialog-body"></div>
		</div>
	</div>
	<footer id="status">
		<span id="status-text"></span>
		<button id="activity-btn" aria-label="Activity log"><i class="ph ph-clock-counter-clockwise"></i>
			Activity</button>
	</footer>
	<script type="module">
		import { parseVaultEvent } from "/seedvault-events.js";
		const { marked } = await import("https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js");
		const matter = (await import("https://cdn.jsdelivr.net/npm/gray-matter@4.0.3/+esm")).default;
		const DOMPurify = (await import("https://cdn.jsdelivr.net/npm/dompurify@3.0.9/+esm")).default;
		const morphdom = (await import("https://cdn.jsdelivr.net/npm/morphdom@2.7.4/+esm")).default;

		const emptyStateHTML = '<div class="empty-state"><i class="ph ph-plant"></i><p>Select a file to view</p></div>';

		function renderMarkdown(raw) {
			if (typeof raw !== "string") return { html: "", meta: {} };
			try {
				const { content, data } = matter(raw);
				const html = marked.parse(content);
				return {
					html: DOMPurify.sanitize(html, { USE_PROFILES: { html: true } }),
					meta: data || {},
				};
			} catch {
				const escaped = raw
					.replace(/&/g, "&amp;")
					.replace(/</g, "&lt;")
					.replace(/>/g, "&gt;")
					.replace(/"/g, "&quot;");
				return { html: "<pre>" + escaped + "</pre>", meta: {} };
			}
		}

		const $ = (id) => document.getElementById(id);
		const tokenEl = $("token");
		const filesEl = $("files");
		const contentEl = $("content-body");
		const statusTextEl = $("status-text");
		const backdropEl = $("backdrop");
		const menuToggleEl = $("menu-toggle");

		function closeSidebar() {
			$("nav").classList.remove("open");
			backdropEl.classList.remove("visible");
		}

		menuToggleEl.addEventListener("click", () => {
			const nav = $("nav");
			nav.classList.toggle("open");
			backdropEl.classList.toggle("visible", nav.classList.contains("open"));
		});

		backdropEl.addEventListener("click", closeSidebar);
		$("nav-close").addEventListener("click", closeSidebar);

		let token = localStorage.getItem("sv-token") || "";
		tokenEl.value = token;

		function status(msg) { statusTextEl.textContent = msg; }

		async function api(url, opts = {}) {
			const res = await fetch(url, {
				...opts,
				headers: {
					...(token ? { Authorization: "Bearer " + token } : {}),
					...(opts.headers || {}),
				},
			});
			if (!res.ok) {
				const body = await res.json().catch(() => ({}));
				throw new Error((body.error || "Request failed") + " (" + res.status + ")");
			}
			return res;
		}

		const selectEl = $("contributor-select");

		function getExpandedKeys() {
			try {
				return new Set(JSON.parse(localStorage.getItem("sv-expanded") || "[]"));
			} catch { return new Set(); }
		}
		function saveExpandedKeys(keys) {
			localStorage.setItem("sv-expanded", JSON.stringify([...keys]));
		}

		function buildTree(fileEntries) {
			const root = {};
			for (const f of fileEntries) {
				const parts = f.path.split("/");
				let node = root;
				for (const part of parts) {
					if (!node[part]) node[part] = {};
					node = node[part];
				}
				node.__file = f;
			}
			return root;
		}

		function formatCtime(iso) {
			if (!iso) return "";
			const d = new Date(iso);
			const mon = d.toLocaleString(undefined, { month: "short" });
			const day = d.getDate();
			const now = new Date();
			if (d.getFullYear() === now.getFullYear()) return mon + " " + day;
			return mon + " " + day + ", " + d.getFullYear();
		}

		function getNewestCtime(node) {
			if (node.__file) return node.__file.createdAt || "";
			let newest = "";
			for (const key of Object.keys(node)) {
				if (key === "__file") continue;
				const t = getNewestCtime(node[key]);
				if (t > newest) newest = t;
			}
			return newest;
		}

		function countFiles(node) {
			let count = 0;
			for (const key of Object.keys(node)) {
				if (key === "__file") { count++; continue; }
				count += countFiles(node[key]);
			}
			return count;
		}

		function renderTree(node, parentUl, username, depth, pathPrefix = "") {
			const keys = Object.keys(node).filter((k) => k !== "__file").sort((a, b) => {
				const aDir = Object.keys(node[a]).some((k) => k !== "__file");
				const bDir = Object.keys(node[b]).some((k) => k !== "__file");
				if (aDir !== bDir) return aDir ? -1 : 1;
				const aTime = getNewestCtime(node[a]);
				const bTime = getNewestCtime(node[b]);
				if (aTime !== bTime) return bTime.localeCompare(aTime);
				return a.localeCompare(b);
			});
			for (const key of keys) {
				const child = node[key];
				const nodePath = pathPrefix ? pathPrefix + "/" + key : key;
				const isFile = child.__file && Object.keys(child).length === 1;
				const li = document.createElement("li");
				li.dataset.key = nodePath;
				const row = document.createElement("div");
				row.className = "tree-row";
				row.style.paddingLeft = (depth * 14 + 12) + "px";

				if (isFile) {
					const ctime = child.__file.createdAt || "";
					row.innerHTML = '<span class="name"><span class="arrow">&nbsp;</span><i class="ph ph-file-text"></i> ' + key + '</span><span class="ctime">' + formatCtime(ctime) + '</span>';
					row.dataset.path = child.__file.path;
					row.dataset.contributor = username;
					row.dataset.action = "open";
				} else {
					const sub = document.createElement("ul");
					const fileCount = countFiles(child);
					const expanded = getExpandedKeys().has(username + ":" + nodePath);
					const arrow = expanded ? "&#9660;" : "&#9654;";
					if (!expanded) sub.classList.add("collapsed");
					row.innerHTML = '<span class="name"><span class="arrow">' + arrow + '</span><i class="ph ph-folder"></i> ' + key + ' <span style="opacity:0.45;font-size:11px">' + fileCount + '</span></span>';
					row.dataset.action = "toggle";
					row.dataset.toggleKey = username + ":" + nodePath;
					renderTree(child, sub, username, depth + 1, nodePath);
					li.appendChild(row);
					li.appendChild(sub);
					parentUl.appendChild(li);
					continue;
				}
				li.appendChild(row);
				parentUl.appendChild(li);
			}
		}

		function markActiveRow() {
			filesEl.querySelectorAll(".tree-row").forEach((r) => r.classList.remove("active"));
			const activePath = localStorage.getItem("sv-file");
			const activeContributor = localStorage.getItem("sv-contributor");
			if (!activePath || !activeContributor) return;
			const active = filesEl.querySelector(
				'.tree-row[data-contributor="' + CSS.escape(activeContributor) + '"][data-path="' + CSS.escape(activePath) + '"]'
			);
			if (active) {
				active.classList.add("active");
				active.scrollIntoView({ block: "nearest", behavior: "smooth" });
			}
		}

		function getVisibleTreeRows() {
			const rows = [];
			function walk(ul) {
				if (!ul || ul.classList.contains("collapsed")) return;
				for (const li of ul.children) {
					const row = li.querySelector(":scope > .tree-row");
					if (row && row.dataset.path) rows.push(row);
					walk(li.querySelector(":scope > ul"));
				}
			}
			walk(filesEl);
			return rows;
		}

		function handleNavKeydown(e) {
			if (e.key !== "ArrowUp" && e.key !== "ArrowDown") return;
			if (["INPUT", "TEXTAREA"].includes(document.activeElement?.tagName)) return;
			const rows = getVisibleTreeRows();
			if (rows.length === 0) return;
			const active = filesEl.querySelector(".tree-row.active");
			let idx = active ? rows.indexOf(active) : -1;
			if (e.key === "ArrowDown") {
				idx = idx < rows.length - 1 ? idx + 1 : idx;
			} else {
				idx = idx > 0 ? idx - 1 : 0;
			}
			e.preventDefault();
			rows[idx].click();
		}

		filesEl.addEventListener("click", (e) => {
			const row = e.target.closest(".tree-row");
			if (!row) return;
			const action = row.dataset.action;
			if (action === "open") {
				loadContent(row.dataset.contributor, row.dataset.path, row);
			} else if (action === "toggle") {
				const sub = row.nextElementSibling;
				if (!sub) return;
				sub.classList.toggle("collapsed");
				const arrow = row.querySelector(".arrow");
				if (arrow) arrow.innerHTML = sub.classList.contains("collapsed") ? "&#9654;" : "&#9660;";
				const keys = getExpandedKeys();
				const toggleKey = row.dataset.toggleKey;
				if (toggleKey) {
					if (sub.classList.contains("collapsed")) keys.delete(toggleKey);
					else keys.add(toggleKey);
					saveExpandedKeys(keys);
				}
			}
		});

		async function loadSelectedContributor(opts = {}) {
			const username = selectEl.value;
			if (!username) return;
			localStorage.setItem("sv-contributor", username);
			const silent = !!opts.silent;
			if (!silent) status("Loading files...");
			const { files } = await (await api("/v1/files?prefix=" + encodeURIComponent(username + "/"))).json();
			const prefix = username + "/";
			const tree = buildTree(files.map((f) => ({
				...f,
				path: f.path.startsWith(prefix) ? f.path.slice(prefix.length) : f.path,
			})));
			const tmp = document.createElement("ul");
			renderTree(tree, tmp, username, 0);
			if (filesEl.hasChildNodes()) {
				morphdom(filesEl, tmp, {
					childrenOnly: true,
					getNodeKey(node) {
						return node.dataset?.key || "";
					},
				});
			} else {
				filesEl.append(...tmp.childNodes);
			}
			markActiveRow();
			status(files.length + " file(s)");
		}

		async function loadContributors() {
			filesEl.innerHTML = "";
			contentEl.innerHTML = emptyStateHTML;
			$("item-header").hidden = true;
			status("Loading contributors...");
			const { contributors } = await (await api("/v1/contributors")).json();

			selectEl.innerHTML = "";
			for (const b of contributors) {
				const opt = document.createElement("option");
				opt.value = b.username;
				opt.textContent = b.username;
				selectEl.appendChild(opt);
			}
			selectEl.disabled = contributors.length === 0;

			const saved = localStorage.getItem("sv-contributor");
			if (saved && contributors.some((c) => c.username === saved)) {
				selectEl.value = saved;
			} else if (contributors.length > 0) {
				selectEl.value = contributors[0].username;
			}

			await loadSelectedContributor();

			const savedFile = localStorage.getItem("sv-file");
			if (savedFile) {
				const match = filesEl.querySelector('[data-path="' + CSS.escape(savedFile) + '"]');
				if (match) await loadContent(selectEl.value, savedFile, match);
			}
		}

		selectEl.addEventListener("change", () => {
			contentEl.innerHTML = emptyStateHTML;
			$("item-header").hidden = true;
			localStorage.removeItem("sv-file");
			loadSelectedContributor().catch((e) => status(e.message));
		});

		function escapeHtml(str) {
			return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
		}

		function renderMeta(meta) {
			const skip = new Set(["title"]);
			const parts = [];
			for (const [key, val] of Object.entries(meta)) {
				if (skip.has(key) || val == null) continue;
				const label = '<span class="meta-label">' + escapeHtml(key) + '</span>';
				let value;
				if (Array.isArray(val)) {
					value = val.map((v) => '<span class="meta-tag">' + escapeHtml(v) + "</span>").join(" ");
				} else {
					value = '<span class="meta-value">' + escapeHtml(val) + "</span>";
				}
				parts.push('<span class="meta-field">' + label + " " + value + "</span>");
			}
			return parts.join("");
		}

		async function loadContent(username, path, row) {
			filesEl.querySelectorAll(".tree-row").forEach((r) => r.classList.remove("active"));
			row.classList.add("active");
			row.scrollIntoView({ block: "nearest", behavior: "smooth" });
			localStorage.setItem("sv-contributor", username);
			localStorage.setItem("sv-file", path);
			closeSidebar();
			status("Loading " + path + "...");
			const encodedPath = path.split("/").map(encodeURIComponent).join("/");
			const res = await api("/v1/files/" + encodeURIComponent(username) + "/" + encodedPath);
			const text = await res.text();
			const { html, meta } = renderMarkdown(text);
			const headerEl = $("item-header");
			const titleEl = $("item-title");
			const pathEl = $("item-path");
			const metaEl = $("item-meta");
			const fileName = path.split("/").pop().replace(/\.md$/, "");
			titleEl.textContent = meta.title || fileName;
			pathEl.textContent = username + ":" + path;
			metaEl.innerHTML = renderMeta(meta);
			headerEl.hidden = false;
			contentEl.innerHTML = html;
			$("content").scrollTop = 0;
			status(path);
		}

		$("connect").onclick = () => {
			token = tokenEl.value.trim();
			localStorage.setItem("sv-token", token);
			loadContributors().then(() => connectSSE()).catch((e) => status(e.message));
		};

		// --- SSE real-time updates ---
		let evtSource = null;
		const contributorReloadTimers = new Map();

		function scheduleContributorReload(username) {
			if (username !== selectEl.value) return;

			const existing = contributorReloadTimers.get(username);
			if (existing) clearTimeout(existing);

			const timer = setTimeout(() => {
				contributorReloadTimers.delete(username);
				if (username !== selectEl.value) return;
				loadSelectedContributor({ silent: true }).catch((e) => status(e.message));
			}, 100);

			contributorReloadTimers.set(username, timer);
		}

		function connectSSE() {
			if (evtSource) evtSource.close();
			if (!token) return;

			evtSource = new EventSource("/v1/events?token=" + encodeURIComponent(token));

			evtSource.addEventListener("file_updated", (e) => {
				const event = parseVaultEvent(e.type, e.data);
				if (!event || event.type !== "file_updated") return;
				scheduleContributorReload(event.contributor);
				if (localStorage.getItem("sv-file") === event.path && localStorage.getItem("sv-contributor") === event.contributor) {
					const encodedPath = event.path.split("/").map(encodeURIComponent).join("/");
					api("/v1/files/" + encodeURIComponent(event.contributor) + "/" + encodedPath)
						.then((res) => res.text())
						.then((text) => {
							const { html, meta } = renderMarkdown(text);
							const fileName = event.path.split("/").pop().replace(/\.md$/, "");
							$("item-title").textContent = meta.title || fileName;
							$("item-path").textContent = event.contributor + ":" + event.path;
							$("item-meta").innerHTML = renderMeta(meta);
							$("item-header").hidden = false;
							contentEl.innerHTML = html;
						});
				}
			});

			evtSource.addEventListener("file_deleted", (e) => {
				const event = parseVaultEvent(e.type, e.data);
				if (!event || event.type !== "file_deleted") return;
				scheduleContributorReload(event.contributor);
				if (localStorage.getItem("sv-file") === event.path && localStorage.getItem("sv-contributor") === event.contributor) {
					$("item-header").hidden = true;
					contentEl.innerHTML = emptyStateHTML;
					status("File deleted: " + event.path);
				}
			});

			evtSource.addEventListener("activity", (e) => {
				const event = parseVaultEvent(e.type, e.data);
				if (!event || event.type !== "activity") return;
				handleActivitySSE(event);
			});

			evtSource.onerror = () => {
				// EventSource auto-reconnects
			};
		}

		if (token) loadContributors().then(() => connectSSE()).catch((e) => status(e.message));

		// Nav keyboard: up/down to move selection
		document.addEventListener("keydown", (e) => {
			if (e.key !== "ArrowUp" && e.key !== "ArrowDown") return;
			if (["INPUT", "TEXTAREA"].includes(document.activeElement?.tagName)) return;
			if (!$("nav-body").contains(document.activeElement) && document.activeElement !== $("nav-body")) return;
			handleNavKeydown(e);
		});

		// Focus nav when clicking in it
		$("nav").addEventListener("mousedown", (e) => {
			if (e.target.closest("#nav-body")) $("nav-body").focus();
		});

		// Divider drag
		const divider = $("divider");
		const nav = $("nav");
		const savedNav = localStorage.getItem("sv-nav-w");
		if (savedNav) nav.style.width = savedNav + "px";
		divider.addEventListener("mousedown", (e) => {
			e.preventDefault();
			divider.classList.add("dragging");
			const onMove = (e) => {
				const w = e.clientX - nav.getBoundingClientRect().left;
				if (w > 80 && w < window.innerWidth - 120) nav.style.width = w + "px";
			};
			const onUp = () => {
				divider.classList.remove("dragging");
				localStorage.setItem("sv-nav-w", nav.offsetWidth);
				document.removeEventListener("mousemove", onMove);
				document.removeEventListener("mouseup", onUp);
			};
			document.addEventListener("mousemove", onMove);
			document.addEventListener("mouseup", onUp);
		});

		// --- Activity modal ---

		const activityModal = $("activity-modal");
		const activityBody = $("activity-dialog-body");
		const ACTIVITY_PAGE_SIZE = 1000;
		let activitySeenIds = new Set();
		let activityOffset = 0;
		let activityHasMore = false;

		function openActivityModal() {
			activitySeenIds = new Set();
			activityOffset = 0;
			activityBody.innerHTML = "";
			activityModal.classList.add("open");
			loadActivityPage();
		}

		function closeActivityModal() {
			activityModal.classList.remove("open");
		}

		function handleActivitySSE(event) {
			if (!activityModal.classList.contains("open")) return;
			if (activitySeenIds.has(event.id)) return;
			activitySeenIds.add(event.id);
			activityOffset++;
			let list = activityBody.querySelector(".activity-list");
			if (!list) {
				const empty = activityBody.querySelector("p");
				if (empty) empty.remove();
				list = document.createElement("ul");
				list.className = "activity-list";
				activityBody.prepend(list);
			}
			list.insertAdjacentHTML("afterbegin", renderActivityItems([event]));
		}

		$("activity-btn").addEventListener("click", openActivityModal);
		$("activity-close").addEventListener("click", closeActivityModal);
		$("activity-overlay").addEventListener("click", closeActivityModal);

		document.addEventListener("keydown", (e) => {
			if (e.key === "Escape" && activityModal.classList.contains("open")) {
				closeActivityModal();
			}
		});

		function formatActivityTime(iso) {
			if (!iso) return { time: "", date: "" };
			const d = new Date(iso);
			const hh = String(d.getHours()).padStart(2, "0");
			const mm = String(d.getMinutes()).padStart(2, "0");
			const ss = String(d.getSeconds()).padStart(2, "0");
			const ms = String(d.getMilliseconds()).padStart(3, "0");
			const mon = d.toLocaleString(undefined, { month: "short" });
			const day = d.getDate();
			const yr = d.getFullYear();
			const now = new Date();
			const dateStr = yr === now.getFullYear()
				? mon + " " + day
				: mon + " " + day + ", " + yr;
			return {
				time: hh + ":" + mm + ":" + ss + "." + ms,
				date: dateStr,
			};
		}

		function parseDetail(raw) {
			if (!raw) return null;
			try { return JSON.parse(raw); } catch { return null; }
		}

		function esc(str) {
			return String(str)
				.replace(/&/g, "&amp;")
				.replace(/</g, "&lt;")
				.replace(/>/g, "&gt;")
				.replace(/"/g, "&quot;");
		}

		function formatDetail(detail) {
			if (!detail || typeof detail !== "object") return "";
			return Object.entries(detail)
				.filter(([k]) => k !== "diff" && k !== "diff_truncated")
				.map(([k, v]) => k + "=" + v)
				.join("  ");
		}

		function renderDiff(raw) {
			if (!raw) return "";
			const lines = raw.split("\n");
			const htmlLines = lines.map((line) => {
				const escaped = esc(line);
				if (line.startsWith("@@")) return '<span class="diff-hunk">' + escaped + '</span>';
				if (line.startsWith("+")) return '<span class="diff-add">' + escaped + '</span>';
				if (line.startsWith("-")) return '<span class="diff-del">' + escaped + '</span>';
				return escaped;
			});
			return htmlLines.join("\n");
		}

		function renderActivityItems(events) {
			return events.map((ev) => {
				const { time, date } = formatActivityTime(ev.created_at);
				const parsed = parseDetail(ev.detail);
				const detail = formatDetail(parsed);
				const diff = parsed?.diff || null;
				const truncated = parsed?.diff_truncated || false;

				let content = '<span class="activity-action">' + esc(ev.action) + '</span>' +
					' <span class="activity-by">by</span>' +
					' <span class="activity-contributor">' + esc(ev.contributor) + '</span>';
				if (detail) content += '<div class="activity-detail">' + esc(detail) + '</div>';
				if (diff) {
					content += '<div class="activity-diff">' + renderDiff(diff) + '</div>';
					if (truncated) content += '<span class="activity-diff-truncated">diff truncated</span>';
				}

				return '<li class="activity-item">' +
					'<div class="activity-time-col">' +
					'<div class="activity-time">' + time + '</div>' +
					'<div class="activity-date">' + date + '</div>' +
					'</div>' +
					'<div class="activity-dot-col">' +
					'<div class="activity-dot"></div>' +
					'<div class="activity-line"></div>' +
					'</div>' +
					'<div class="activity-content">' + content + '</div>' +
					'</li>';
			}).join("");
		}

		async function loadActivityPage() {
			const existingBtn = activityBody.querySelector("#activity-load-more");
			if (existingBtn) existingBtn.remove();

			const limit = ACTIVITY_PAGE_SIZE;
			const offset = activityOffset;
			const url = "/v1/activity?limit=" + (limit + 1) + "&offset=" + offset;
			const { events } = await (await api(url)).json();

			activityHasMore = events.length > limit;
			const page = activityHasMore ? events.slice(0, limit) : events;
			for (const ev of page) activitySeenIds.add(ev.id);
			activityOffset += page.length;

			let list = activityBody.querySelector(".activity-list");
			if (!list) {
				list = document.createElement("ul");
				list.className = "activity-list";
				activityBody.appendChild(list);
			}

			if (activitySeenIds.size === 0) {
				activityBody.innerHTML = '<p style="padding:16px;color:var(--text-tertiary);font-size:13px">No activity yet.</p>';
				return;
			}

			list.insertAdjacentHTML("beforeend", renderActivityItems(page));

			if (activityHasMore) {
				const btn = document.createElement("button");
				btn.id = "activity-load-more";
				btn.textContent = "Load more";
				btn.addEventListener("click", () => loadActivityPage());
				activityBody.appendChild(btn);
			}
		}
	</script>
</body>

</html>
