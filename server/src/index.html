<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Seedvault</title>
    <style>
      * { box-sizing: border-box; margin: 0; }
      html {
        color-scheme: light dark;
        font-family: ui-monospace, "Cascadia Mono", "SF Mono", Menlo, monospace;
        font-size: 13px;
      }
      html, body { height: 100%; }
      body {
        padding: 12px;
        display: flex;
        flex-direction: column;
      }
      .top { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; flex-shrink: 0; }
      input, select, button {
        font: inherit;
        padding: 4px 8px;
        background: transparent;
        color: inherit;
        border: 1px solid;
      }
      #token { min-width: 260px; flex: 1; }
      button { cursor: pointer; }
      .grid {
        display: flex;
        gap: 0;
        flex: 1;
        min-height: 0;
      }
      .grid > .panel:first-child { flex-shrink: 0; }
      .grid > .panel:last-child { flex: 1; min-width: 0; }
      .divider {
        width: 5px;
        cursor: col-resize;
        background: transparent;
        flex-shrink: 0;
      }
      .divider:hover, .divider.dragging {
        background: color-mix(in srgb, currentColor 20%, transparent);
      }
      @media (max-width: 600px) {
        .grid { flex-direction: column; }
        .grid > .panel:first-child { width: auto; }
        .divider { display: none; }
      }
      .panel {
        border: 1px solid;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
      }
      .panel-head {
        padding: 4px 8px;
        border-bottom: 1px solid;
        font-weight: bold;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        flex-shrink: 0;
      }
      .panel-body {
        flex: 1;
        overflow: auto;
      }
      .tree { list-style: none; padding: 0; }
      .tree ul { list-style: none; padding: 0; }
      .tree-row {
        display: block;
        width: 100%;
        text-align: left;
        border: none;
        padding: 3px 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
      }
      .tree-row:hover { background: color-mix(in srgb, currentColor 8%, transparent); }
      .tree-row.active { font-weight: bold; }
      .tree-row .arrow { display: inline-block; width: 1em; text-align: center; }
      .tree ul.collapsed { display: none; }
      #content {
        padding: 8px;
        white-space: pre-wrap;
        overflow: auto;
        line-height: 1.4;
      }
      #status { margin-top: 8px; font-size: 11px; opacity: 0.6; flex-shrink: 0; }
    </style>
  </head>
  <body>
    <div class="top">
      <input id="token" type="password" placeholder="API key (&quot;sv_...&quot;)" />
      <button id="connect">Load</button>
    </div>
    <div class="grid">
      <section id="nav" class="panel" style="width:220px">
        <div class="panel-head">Files</div>
        <div class="panel-body"><ul id="files" class="tree"></ul></div>
      </section>
      <div id="divider" class="divider"></div>
      <section class="panel">
        <div class="panel-head">Content</div>
        <div class="panel-body"><pre id="content"></pre></div>
      </section>
    </div>
    <div id="status"></div>
    <script>
      const $ = (id) => document.getElementById(id);
      const tokenEl = $("token");
      const filesEl = $("files");
      const contentEl = $("content");
      const statusEl = $("status");

      let token = localStorage.getItem("sv-token") || "";
      tokenEl.value = token;

      function status(msg) { statusEl.textContent = msg; }

      async function api(url) {
        const res = await fetch(url, {
          headers: token ? { Authorization: "Bearer " + token } : {},
        });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          throw new Error((body.error || "Request failed") + " (" + res.status + ")");
        }
        return res;
      }

      const savedBank = localStorage.getItem("sv-bank") || "";
      const savedFile = localStorage.getItem("sv-file") || "";

      function buildTree(paths) {
        const root = {};
        for (const p of paths) {
          const parts = p.split("/");
          let node = root;
          for (const part of parts) {
            if (!node[part]) node[part] = {};
            node = node[part];
          }
          node.__file = p;
        }
        return root;
      }

      function renderTree(node, parentUl, bankId, depth) {
        const keys = Object.keys(node).filter((k) => k !== "__file").sort((a, b) => {
          const aDir = Object.keys(node[a]).some((k) => k !== "__file");
          const bDir = Object.keys(node[b]).some((k) => k !== "__file");
          if (aDir !== bDir) return aDir ? -1 : 1;
          return a.localeCompare(b);
        });
        for (const key of keys) {
          const child = node[key];
          const isFile = child.__file && Object.keys(child).length === 1;
          const li = document.createElement("li");
          const row = document.createElement("div");
          row.className = "tree-row";
          row.style.paddingLeft = (depth * 12 + 8) + "px";

          if (isFile) {
            row.innerHTML = '<span class="arrow">&nbsp;</span>' + key;
            row.dataset.path = child.__file;
            row.dataset.bank = bankId;
            row.onclick = () => loadContent(bankId, child.__file, row);
          } else {
            const sub = document.createElement("ul");
            row.innerHTML = '<span class="arrow">&#9660;</span>' + key;
            row.onclick = () => {
              sub.classList.toggle("collapsed");
              row.querySelector(".arrow").innerHTML = sub.classList.contains("collapsed") ? "&#9654;" : "&#9660;";
            };
            renderTree(child, sub, bankId, depth + 1);
            li.appendChild(row);
            li.appendChild(sub);
            parentUl.appendChild(li);
            continue;
          }
          li.appendChild(row);
          parentUl.appendChild(li);
        }
      }

      async function loadBankFiles(bankId, sub) {
        sub.innerHTML = "";
        status("Loading files...");
        const { files } = await (await api("/v1/banks/" + encodeURIComponent(bankId) + "/files")).json();
        const tree = buildTree(files.map((f) => f.path));
        renderTree(tree, sub, bankId, 1);
        status(files.length + " file(s)");
      }

      async function loadBanks() {
        filesEl.innerHTML = "";
        contentEl.textContent = "";
        status("Loading banks...");
        const { banks } = await (await api("/v1/banks")).json();

        for (const b of banks) {
          const li = document.createElement("li");
          const row = document.createElement("div");
          row.className = "tree-row";
          row.style.paddingLeft = "8px";
          const sub = document.createElement("ul");
          sub.dataset.bank = b.id;
          sub.dataset.loaded = "false";
          let loaded = false;
          row.innerHTML = '<span class="arrow">&#9654;</span>' + b.name;
          row.onclick = async () => {
            const collapsed = sub.classList.contains("collapsed") || !sub.hasChildNodes();
            if (collapsed) {
              sub.classList.remove("collapsed");
              row.querySelector(".arrow").innerHTML = "&#9660;";
              if (!loaded) {
                loaded = true;
                sub.dataset.loaded = "true";
                await loadBankFiles(b.id, sub);
              }
            } else {
              sub.classList.add("collapsed");
              row.querySelector(".arrow").innerHTML = "&#9654;";
            }
          };
          li.appendChild(row);
          li.appendChild(sub);
          filesEl.appendChild(li);

          if (b.id === savedBank) {
            sub.classList.remove("collapsed");
            row.querySelector(".arrow").innerHTML = "&#9660;";
            loaded = true;
            sub.dataset.loaded = "true";
            await loadBankFiles(b.id, sub);
            if (savedFile) {
              const match = filesEl.querySelector('[data-path="' + CSS.escape(savedFile) + '"]');
              if (match) await loadContent(b.id, savedFile, match);
            }
          }
        }
        status(banks.length + " bank(s)");
      }

      async function loadContent(bankId, path, row) {
        filesEl.querySelectorAll(".tree-row").forEach((r) => r.classList.remove("active"));
        row.classList.add("active");
        localStorage.setItem("sv-bank", bankId);
        localStorage.setItem("sv-file", path);
        status("Loading " + path + "...");
        const encodedPath = path.split("/").map(encodeURIComponent).join("/");
        const res = await api("/v1/banks/" + encodeURIComponent(bankId) + "/files/" + encodedPath);
        contentEl.textContent = await res.text();
        status(path);
      }

      $("connect").onclick = () => {
        token = tokenEl.value.trim();
        localStorage.setItem("sv-token", token);
        loadBanks().then(() => connectSSE()).catch((e) => status(e.message));
      };

      // --- SSE real-time updates ---
      let evtSource = null;

      function connectSSE() {
        if (evtSource) evtSource.close();
        if (!token) return;

        evtSource = new EventSource("/v1/events?token=" + encodeURIComponent(token));

        evtSource.addEventListener("file_updated", (e) => {
          const { bank, path, size, modifiedAt } = JSON.parse(e.data);
          // Add file to tree if missing
          const existing = filesEl.querySelector('[data-path="' + CSS.escape(path) + '"]');
          if (!existing) {
            addFileToTree(bank, path);
          }
          // If this file is currently open, reload its content
          if (localStorage.getItem("sv-file") === path && localStorage.getItem("sv-bank") === bank) {
            const encodedPath = path.split("/").map(encodeURIComponent).join("/");
            api("/v1/banks/" + encodeURIComponent(bank) + "/files/" + encodedPath)
              .then((res) => res.text())
              .then((text) => { contentEl.textContent = text; });
          }
        });

        evtSource.addEventListener("file_deleted", (e) => {
          const { bank, path } = JSON.parse(e.data);
          const row = filesEl.querySelector('[data-path="' + CSS.escape(path) + '"]');
          if (row) {
            const li = row.parentElement;
            li.remove();
            // Clean up empty parent directories
            pruneEmptyDirs(filesEl);
          }
          // If this file was being viewed, clear the content
          if (localStorage.getItem("sv-file") === path && localStorage.getItem("sv-bank") === bank) {
            contentEl.textContent = "";
            status("File deleted: " + path);
          }
        });

        evtSource.onerror = () => {
          // EventSource auto-reconnects
        };
      }

      /** Remove empty <ul> directory containers left after file deletions.
       *  Preserves bank-level nodes (direct children of #files). */
      function pruneEmptyDirs(root) {
        const uls = root.querySelectorAll("ul");
        for (let i = uls.length - 1; i >= 0; i--) {
          const ul = uls[i];
          if (ul.id === "files") continue;
          if (ul.children.length === 0) {
            const parentLi = ul.parentElement;
            if (parentLi && parentLi.parentElement !== filesEl) parentLi.remove();
          }
        }
      }

      /** Insert a new file path into the existing tree UI */
      function addFileToTree(bankId, path) {
        // Update only banks whose file list has been loaded in the UI.
        const targetUl = filesEl.querySelector(
          'ul[data-bank="' + CSS.escape(bankId) + '"][data-loaded="true"]'
        );
        if (!targetUl) return; // bank not expanded yet, nothing to update

        // Split path into segments and navigate/create tree nodes
        const parts = path.split("/");
        let currentUl = targetUl;

        for (let i = 0; i < parts.length; i++) {
          const part = parts[i];
          const isLast = i === parts.length - 1;
          const depth = i + 1;

          if (isLast) {
            // Create file row
            const li = document.createElement("li");
            const row = document.createElement("div");
            row.className = "tree-row";
            row.style.paddingLeft = (depth * 12 + 8) + "px";
            row.innerHTML = '<span class="arrow">&nbsp;</span>' + part;
            row.dataset.path = path;
            row.dataset.bank = bankId;
            row.onclick = () => loadContent(bankId, path, row);
            li.appendChild(row);
            currentUl.appendChild(li);
          } else {
            // Find or create directory
            let found = null;
            for (const li of currentUl.children) {
              const row = li.querySelector(".tree-row");
              if (!row) continue;
              // Directory rows don't have data-path
              if (!row.dataset.path && row.textContent.trim().replace(/[▶▼]/g, "").trim() === part) {
                found = li.querySelector("ul");
                break;
              }
            }
            if (!found) {
              const li = document.createElement("li");
              const row = document.createElement("div");
              row.className = "tree-row";
              row.style.paddingLeft = (depth * 12 + 8) + "px";
              const sub = document.createElement("ul");
              row.innerHTML = '<span class="arrow">&#9660;</span>' + part;
              row.onclick = () => {
                sub.classList.toggle("collapsed");
                row.querySelector(".arrow").innerHTML = sub.classList.contains("collapsed") ? "&#9654;" : "&#9660;";
              };
              li.appendChild(row);
              li.appendChild(sub);
              currentUl.appendChild(li);
              found = sub;
            }
            currentUl = found;
          }
        }
      }

      if (token) loadBanks().then(() => connectSSE()).catch((e) => status(e.message));

      // Divider drag
      const divider = $("divider");
      const nav = $("nav");
      const savedNav = localStorage.getItem("sv-nav-w");
      if (savedNav) nav.style.width = savedNav + "px";
      divider.addEventListener("mousedown", (e) => {
        e.preventDefault();
        divider.classList.add("dragging");
        const onMove = (e) => {
          const w = e.clientX - nav.getBoundingClientRect().left;
          if (w > 80 && w < window.innerWidth - 120) nav.style.width = w + "px";
        };
        const onUp = () => {
          divider.classList.remove("dragging");
          localStorage.setItem("sv-nav-w", nav.offsetWidth);
          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", onUp);
        };
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onUp);
      });
    </script>
  </body>
</html>
